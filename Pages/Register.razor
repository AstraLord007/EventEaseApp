@page "/"
@page "/register"
@using EventEaseApp.Data
@using Microsoft.AspNetCore.Components.Forms
@inject SessionService SessionService
@inject NavigationManager NavigationManager

<h3>Registro de Usuario</h3>

<EditForm Model="@newUser" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Nombre:</label>
        <InputText @bind-Value="newUser.Name" class="form-control" />
        <ValidationMessage For="@(() => newUser.Name)" />
    </div>

    <div class="form-group">
        <label>Correo electrÃ³nico:</label>
        <InputText @bind-Value="newUser.Email" class="form-control" />
        <ValidationMessage For="@(() => newUser.Email)" />
    </div>

    <button type="submit" class="btn btn-primary">Registrarse</button>
</EditForm>

@if (successMessageVisible)
{
    <div class="alert alert-success mt-3">
        âœ… Usuario registrado correctamente: @SessionService.GetCurrentUser()?.Name
    </div>
}

@if (logoutMessageVisible)
{
    <div class="alert alert-info mt-3">
        ðŸ”’ SesiÃ³n cerrada correctamente
    </div>
}

<hr />

@if (SessionService.IsLoggedIn)
{
    <p>ðŸ‘¤ Usuario actual: @SessionService.GetCurrentUser()?.Name (@SessionService.GetCurrentUser()?.Email)</p>
    <button class="btn btn-danger" @onclick="CerrarSesion">Cerrar sesiÃ³n</button>
}
else
{
    <p>No hay usuario en sesiÃ³n.</p>
}

@code {
    private User newUser = new();
    private bool successMessageVisible = false;
    private bool logoutMessageVisible = false;

    private async Task HandleValidSubmit()
    {
        // Guardamos el usuario en sesiÃ³n
        await SessionService.Login(newUser);

        successMessageVisible = true;
        logoutMessageVisible = false;

        // Reiniciamos el formulario
        newUser = new User();

        // ðŸ”¹ Redirigir automÃ¡ticamente a la pÃ¡gina de eventos
        NavigationManager.NavigateTo("/events");
    }

    private async Task CerrarSesion()
    {
        await SessionService.Logout();
        successMessageVisible = false;
        logoutMessageVisible = true;

        // ðŸ”¹ Redirigir nuevamente al registro
        NavigationManager.NavigateTo("/register");
    }
}