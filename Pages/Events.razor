@page "/events"
@using EventEaseApp.Data
@using Microsoft.AspNetCore.Components.Forms
@inject EventService EventService
@inject SessionService SessionService
@inject NavigationManager NavigationManager

@if (!SessionService.IsLoggedIn)
{
    <div class="alert alert-warning">
        ‚ö†Ô∏è Acceso restringido: debes registrarte o iniciar sesi√≥n para poder crear y gestionar eventos.
    </div>
}
else
{
    <div class="events-layout">
        <!-- Formulario fijo a la izquierda -->
        <div class="event-form">
            <EditForm Model="@newEvent" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label>Nombre del evento:</label>
                    <InputText @bind-Value="newEvent.Name" class="form-control" />
                    <ValidationMessage For="@(() => newEvent.Name)" />
                </div>

                <div class="form-group">
                    <label>Fecha:</label>
                    <InputDate @bind-Value="newEvent.Date" class="form-control" />
                    <ValidationMessage For="@(() => newEvent.Date)" />
                </div>

                <div class="form-group">
                    <label>Ubicaci√≥n:</label>
                    <InputText @bind-Value="newEvent.Location" class="form-control" />
                    <ValidationMessage For="@(() => newEvent.Location)" />
                </div>

                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <InputTextArea @bind-Value="newEvent.Description" class="form-control" />
                    <ValidationMessage For="@(() => newEvent.Description)" />
                </div>

                <button type="submit" class="btn btn-primary">Registrar</button>
            </EditForm>

            @if (successMessageVisible)
            {
                <div class="alert alert-success mt-3">
                    üéâ Evento registrado correctamente
                </div>
            }
        </div>

        <!-- Lista de eventos -->
        <div class="events-list">
            <h4>Lista de eventos</h4>
            @if (events.Any())
            {
                <div class="event-grid">
                    @foreach (var ev in PagedEvents.Where(e =>
                                !string.IsNullOrWhiteSpace(e.Name) &&
                                !string.IsNullOrWhiteSpace(e.Location) &&
                                !string.IsNullOrWhiteSpace(e.Description)))
                    {
                        <div class="event-card">
                            <EventCard Event="ev" OnEventUpdated="RefrescarEventos" />
                        </div>
                    }
                </div>

                <!-- Paginaci√≥n centrada -->
                <div class="pagination mt-3">
                    <button class="btn btn-secondary me-2" @onclick="PrevPage" disabled="@(!CanGoPrev)">Anterior</button>
                    <button class="btn btn-secondary" @onclick="NextPage" disabled="@(!CanGoNext)">Siguiente</button>
                    <span class="ms-3">P√°gina @currentPage de @totalPages</span>
                </div>
            }
            else
            {
                <p>No hay eventos registrados a√∫n.</p>
            }
        </div>
    </div>
}

<ErrorAlert ShowError="@hasError" />

@code {
    private Event newEvent = new Event { Date = DateTime.Now };
    private List<Event> events = new();
    private bool successMessageVisible = false;
    private bool hasError = false;

    private int pageSize = 4;
    private int currentPage = 1;
    private int totalPages => (int)Math.Ceiling(events.Count / (double)pageSize);

    private IEnumerable<Event> PagedEvents =>
    events.Skip((currentPage - 1) * pageSize).Take(pageSize);

    protected override void OnInitialized()
    {
        try
        {
            if (!SessionService.IsLoggedIn)
            {
                NavigationManager.NavigateTo("/register");
                return;
            }

            events = EventService.GetEvents();
            AjustarPagina(); // üîπ recalcular al iniciar
        }
        catch (Exception)
        {
            hasError = true;
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            await EventService.AddEvent(newEvent);
            successMessageVisible = true;
            newEvent = new Event { Date = DateTime.Now };
            events = EventService.GetEvents();

            AjustarPagina(); // üîπ recalcular al agregar
        }
        catch (Exception)
        {
            hasError = true;
        }
    }

    private void RefrescarEventos()
    {
        try
        {
            events = EventService.GetEvents();
            AjustarPagina(); // üîπ recalcular al refrescar
            StateHasChanged();
        }
        catch (Exception)
        {
            hasError = true;
        }
    }

    private void NextPage()
    {
        if (CanGoNext)
        {
            currentPage++;
        }
    }

    private void PrevPage()
    {
        if (CanGoPrev)
        {
            currentPage--;
        }
    }

    // üîπ Ajusta la p√°gina actual para que nunca quede fuera de rango
    private void AjustarPagina()
    {
        if (totalPages == 0)
        {
            currentPage = 1;
        }
        else if (currentPage > totalPages)
        {
            currentPage = totalPages;
        }
        else if (currentPage < 1)
        {
            currentPage = 1;
        }
    }

    private bool CanGoNext =>
    events.Count > currentPage * pageSize; // ‚úÖ solo si hay eventos en la siguiente p√°gina

    private bool CanGoPrev => currentPage > 1;
}