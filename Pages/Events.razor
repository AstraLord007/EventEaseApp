@page "/events"
@using EventEaseApp.Data
@using Microsoft.AspNetCore.Components.Forms
@inject EventService EventService
@inject SessionService SessionService
@inject NavigationManager NavigationManager

<h3>Eventos</h3>

@if (!SessionService.IsLoggedIn)
{
    <div class="alert alert-warning">
        锔 Acceso restringido: debes registrarte o iniciar sesi贸n para poder crear y gestionar eventos.
    </div>
}
else
{
    <!-- Formulario de registro de eventos -->
    <EditForm Model="@newEvent" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label>Nombre del evento:</label>
            <InputText @bind-Value="newEvent.Name" class="form-control" />
            <ValidationMessage For="@(() => newEvent.Name)" />
        </div>

        <div class="form-group">
            <label>Fecha:</label>
            <InputDate @bind-Value="newEvent.Date" class="form-control" />
            <ValidationMessage For="@(() => newEvent.Date)" />
        </div>

        <div class="form-group">
            <label>Ubicaci贸n:</label>
            <InputText @bind-Value="newEvent.Location" class="form-control" />
            <ValidationMessage For="@(() => newEvent.Location)" />
        </div>

        <div class="form-group">
            <label>Descripci贸n:</label>
            <InputTextArea @bind-Value="newEvent.Description" class="form-control" />
            <ValidationMessage For="@(() => newEvent.Description)" />
        </div>

        <button type="submit" class="btn btn-primary">Registrar</button>
    </EditForm>

    @if (successMessageVisible)
    {
        <div class="alert alert-success mt-3">
             Evento registrado correctamente
        </div>
    }

    <hr />

    <h4>Lista de eventos</h4>
    @if (events.Any())
    {
        <!-- Virtualize con paginaci贸n -->
        <Virtualize Items="@PagedEvents.ToList()" Context="ev" TItem="Event">
            <EventCard Event="ev" OnEventUpdated="RefrescarEventos" />
        </Virtualize>

        <!-- Controles de paginaci贸n -->
        <div class="mt-3">
            <button class="btn btn-secondary me-2" @onclick="PrevPage" disabled="@(!CanGoPrev)">Anterior</button>
            <button class="btn btn-secondary" @onclick="NextPage" disabled="@(!CanGoNext)">Siguiente</button>
            <span class="ms-3">P谩gina @currentPage de @totalPages</span>
        </div>
    }
    else
    {
        <p>No hay eventos registrados a煤n.</p>
    }
}

@code {
    private Event newEvent = new Event { Date = DateTime.Now };
    private List<Event> events = new();
    private bool successMessageVisible = false;

    //  Paginaci贸n
    private int pageSize = 10; // cantidad de eventos por p谩gina
    private int currentPage = 1;
    private int totalPages => (int)Math.Ceiling(events.Count / (double)pageSize);

    private IEnumerable<Event> PagedEvents =>
    events.Skip((currentPage - 1) * pageSize).Take(pageSize);

    protected override void OnInitialized()
    {
        if (!SessionService.IsLoggedIn)
        {
            NavigationManager.NavigateTo("/register");
            return;
        }

        events = EventService.GetEvents();
    }

    private async Task HandleValidSubmit()
    {
        await EventService.AddEvent(newEvent);
        successMessageVisible = true;
        newEvent = new Event { Date = DateTime.Now };
        events = EventService.GetEvents();
    }

    private void RefrescarEventos()
    {
        events = EventService.GetEvents();
        StateHasChanged();
    }

    private void NextPage()
    {
        if (CanGoNext)
        {
            currentPage++;
        }
    }

    private void PrevPage()
    {
        if (CanGoPrev)
        {
            currentPage--;
        }
    }

    private bool CanGoNext => currentPage < totalPages;
    private bool CanGoPrev => currentPage > 1;
}