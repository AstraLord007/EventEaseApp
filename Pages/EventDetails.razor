@page "/eventdetails/{Id:guid}"
@inject EventService EventService
@inject SessionService SessionService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@using EventEaseApp.Data

<div class="event-details-card">
    <h1 class="event-details-title">Detalles del evento</h1>

    <EditForm Model="@selectedEvent" OnValidSubmit="GuardarCambios">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            <label>Nombre:</label>
            <InputText @bind-Value="selectedEvent.Name" class="form-control" />
            <ValidationMessage For="@(() => selectedEvent.Name)" />
        </div>

        <div class="form-group">
            <label>Fecha:</label>
            <InputDate @bind-Value="selectedEvent.Date" class="form-control" />
            <ValidationMessage For="@(() => selectedEvent.Date)" />
        </div>

        <div class="form-group">
            <label>Ubicación:</label>
            <InputText @bind-Value="selectedEvent.Location" class="form-control" />
            <ValidationMessage For="@(() => selectedEvent.Location)" />
        </div>

        <div class="form-group">
            <label>Descripción:</label>
            <InputTextArea @bind-Value="selectedEvent.Description" class="form-control" />
            <ValidationMessage For="@(() => selectedEvent.Description)" />
        </div>

        <div class="event-details-actions">
            <button type="submit" class="btn btn-primary">Guardar cambios</button>
            <button type="button" class="btn btn-danger" @onclick="EliminarEvento">
                Eliminar evento
            </button>
        </div>
    </EditForm>

    @if (mensajeError)
    {
        <div class="alert alert-danger mt-3">
            ⚠️ Los campos Nombre, Ubicación y Descripción no pueden estar vacíos.
        </div>
    }

    @if (mensajeGuardado)
    {
        <div class="alert alert-success mt-3">
            ✅ Cambios guardados correctamente, redirigiendo a la lista de eventos...
        </div>
    }
</div>

@code {
    [Parameter] public Guid Id { get; set; }
    private Event selectedEvent = new Event();
    private bool mensajeGuardado = false;
    private bool mensajeError = false;

    protected override void OnInitialized()
    {
        var ev = EventService.GetEvents().FirstOrDefault(e => e.Id == Id);

        if (ev is not null)
        {
            selectedEvent = ev;
        }
        else
        {
            selectedEvent = new Event
            {
                Name = "Evento no encontrado",
                Date = DateTime.Now,
                Location = "N/A",
                Description = "Sin descripción disponible"
            };
        }
    }

    private async Task GuardarCambios()
    {
        // Validación adicional por seguridad
        if (string.IsNullOrWhiteSpace(selectedEvent.Name) ||
        string.IsNullOrWhiteSpace(selectedEvent.Location) ||
        string.IsNullOrWhiteSpace(selectedEvent.Description))
        {
            mensajeError = true;
            mensajeGuardado = false;
            return;
        }

        await EventService.UpdateEvent(selectedEvent);
        mensajeError = false;
        mensajeGuardado = true;
        NavigationManager.NavigateTo("/events");
    }

    private async Task EliminarEvento()
    {
        bool confirmar = await JSRuntime.InvokeAsync<bool>(
        "confirm", $"¿Seguro que deseas eliminar el evento '{selectedEvent.Name}'?");
        if (confirmar)
        {
            await EventService.DeleteEvent(selectedEvent.Id);
            NavigationManager.NavigateTo("/events");
        }
    }
}